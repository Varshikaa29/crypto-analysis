<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CryptoPulse - Market Analysis</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        dark: {
                            900: '#0f172a',
                            800: '#1e293b',
                            700: '#334155',
                        },
                        brand: {
                            500: '#3b82f6',
                            600: '#2563eb',
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #0f172a;
            color: #f1f5f9;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b; 
        }
        ::-webkit-scrollbar-thumb {
            background: #475569; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b; 
        }

        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .loading-spinner {
            border: 3px solid rgba(255,255,255,0.1);
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="antialiased min-h-screen flex flex-col">

    <!-- Header / Navbar -->
    <nav class="sticky top-0 z-50 glass-panel border-b border-gray-800">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <!-- Logo -->
                <div class="flex items-center gap-2 cursor-pointer" onclick="app.resetView()">
                    <i class="ph-fill ph-chart-polar text-brand-500 text-3xl"></i>
                    <span class="text-xl font-bold bg-gradient-to-r from-blue-400 to-teal-400 bg-clip-text text-transparent">CryptoPulse</span>
                </div>

                <!-- Search Bar -->
                <div class="hidden md:flex flex-1 max-w-md mx-8 relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="ph ph-magnifying-glass text-gray-400"></i>
                    </div>
                    <input 
                        type="text" 
                        id="searchInput"
                        class="block w-full pl-10 pr-3 py-2 border border-gray-700 rounded-lg leading-5 bg-gray-800 text-gray-300 placeholder-gray-500 focus:outline-none focus:bg-gray-900 focus:border-brand-500 transition duration-150 ease-in-out sm:text-sm" 
                        placeholder="Search coins (e.g., bitcoin, eth)..."
                    >
                    <div id="searchResults" class="absolute top-full left-0 right-0 mt-2 bg-gray-800 border border-gray-700 rounded-lg shadow-xl hidden z-50 max-h-60 overflow-y-auto">
                        <!-- Search results injected here -->
                    </div>
                </div>

                <!-- Settings / Global Stats -->
                <div class="flex items-center gap-4">
                    <button id="refreshBtn" class="p-2 text-gray-400 hover:text-white transition-colors" title="Refresh Data">
                        <i class="ph ph-arrows-clockwise text-xl"></i>
                    </button>
                    <button onclick="app.toggleSettings()" class="p-2 text-gray-400 hover:text-white transition-colors" title="API Settings">
                        <i class="ph ph-gear text-xl"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Global Market Stats Bar -->
    <div class="bg-gray-900 border-b border-gray-800 py-2">
        <div class="max-w-7xl mx-auto px-4 flex overflow-x-auto gap-8 text-xs sm:text-sm whitespace-nowrap scrollbar-hide">
            <div class="flex items-center gap-2">
                <span class="text-gray-400">Coins:</span>
                <span class="text-blue-400 font-medium" id="globalCoins">-</span>
            </div>
            <div class="flex items-center gap-2">
                <span class="text-gray-400">Exchanges:</span>
                <span class="text-blue-400 font-medium" id="globalExchanges">-</span>
            </div>
            <div class="flex items-center gap-2">
                <span class="text-gray-400">Market Cap:</span>
                <span class="text-blue-400 font-medium" id="globalMcap">-</span>
            </div>
            <div class="flex items-center gap-2">
                <span class="text-gray-400">24h Vol:</span>
                <span class="text-blue-400 font-medium" id="globalVol">-</span>
            </div>
            <div class="flex items-center gap-2">
                <span class="text-gray-400">BTC Dom:</span>
                <span class="text-blue-400 font-medium" id="globalBtcDom">-</span>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="flex-1 max-w-7xl w-full mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Error / Status Message -->
        <div id="statusMessage" class="hidden mb-6 p-4 rounded-lg bg-yellow-900/30 border border-yellow-700/50 text-yellow-200 text-sm flex items-center gap-3">
            <i class="ph ph-warning-circle text-xl"></i>
            <span id="statusText">Loading market data...</span>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Left Column: Market Table (Takes 2/3 on large screens) -->
            <div class="lg:col-span-2 space-y-6">
                
                <!-- Section Header -->
                <div class="flex items-center justify-between">
                    <h2 class="text-2xl font-bold text-white">Market Overview</h2>
                    <div class="flex gap-2">
                        <button class="px-3 py-1 text-xs rounded-full bg-brand-600 text-white hover:bg-brand-700" onclick="app.loadMarketData(1)">Page 1</button>
                        <button class="px-3 py-1 text-xs rounded-full bg-gray-700 text-gray-300 hover:bg-gray-600" onclick="app.loadMarketData(2)">Next</button>
                    </div>
                </div>

                <!-- Table Container -->
                <div class="glass-panel rounded-xl overflow-hidden shadow-lg">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-gray-800/50 text-gray-400 text-xs uppercase tracking-wider">
                                    <th class="p-4 font-medium">Asset</th>
                                    <th class="p-4 font-medium text-right">Price</th>
                                    <th class="p-4 font-medium text-right">24h %</th>
                                    <th class="p-4 font-medium text-right hidden sm:table-cell">Market Cap</th>
                                    <th class="p-4 font-medium text-right hidden md:table-cell">Volume (24h)</th>
                                </tr>
                            </thead>
                            <tbody id="cryptoTableBody" class="text-sm divide-y divide-gray-800">
                                <!-- JS will populate this -->
                                <tr>
                                    <td colspan="5" class="p-8 text-center text-gray-500">
                                        <div class="flex flex-col items-center justify-center gap-2">
                                            <div class="loading-spinner"></div>
                                            <p>Fetching latest prices...</p>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Right Column: Trending & Details (Takes 1/3) -->
            <div class="space-y-6">
                
                <!-- Trending Section -->
                <div class="glass-panel rounded-xl p-6 shadow-lg">
                    <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                        <i class="ph-fill ph-fire text-orange-500"></i> Trending Now
                    </h3>
                    <div id="trendingList" class="space-y-4">
                        <!-- Trending items injected here -->
                        <div class="animate-pulse flex gap-3 items-center">
                            <div class="w-8 h-8 bg-gray-700 rounded-full"></div>
                            <div class="h-4 bg-gray-700 rounded w-24"></div>
                        </div>
                    </div>
                </div>

                <!-- Detail View (Initially Hidden, shows on click) -->
                <div id="coinDetailPanel" class="hidden glass-panel rounded-xl p-6 shadow-lg border-t-4 border-brand-500 fade-in sticky top-24">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center gap-3">
                            <img id="detailIcon" src="" alt="" class="w-10 h-10 rounded-full">
                            <div>
                                <h3 id="detailName" class="text-xl font-bold text-white">Bitcoin</h3>
                                <span id="detailSymbol" class="text-gray-400 uppercase text-sm">BTC</span>
                            </div>
                        </div>
                        <div class="text-right">
                            <div id="detailPrice" class="text-2xl font-bold text-white">$0.00</div>
                            <div id="detailChange" class="text-sm font-medium">0.00%</div>
                        </div>
                    </div>
                    
                    <!-- Quick Stats Grid -->
                    <div class="grid grid-cols-2 gap-4 mb-6 text-xs">
                        <div class="bg-gray-800/50 p-3 rounded-lg">
                            <span class="block text-gray-500 mb-1">Market Cap</span>
                            <span id="detailMcap" class="text-gray-200 font-medium">-</span>
                        </div>
                        <div class="bg-gray-800/50 p-3 rounded-lg">
                            <span class="block text-gray-500 mb-1">24h High</span>
                            <span id="detailHigh" class="text-gray-200 font-medium">-</span>
                        </div>
                        <div class="bg-gray-800/50 p-3 rounded-lg">
                            <span class="block text-gray-500 mb-1">24h Low</span>
                            <span id="detailLow" class="text-gray-200 font-medium">-</span>
                        </div>
                        <div class="bg-gray-800/50 p-3 rounded-lg">
                            <span class="block text-gray-500 mb-1">Total Vol</span>
                            <span id="detailVol" class="text-gray-200 font-medium">-</span>
                        </div>
                    </div>

                    <!-- Chart Container -->
                    <div class="h-64 w-full bg-gray-800/30 rounded-lg p-2 mb-4">
                        <canvas id="priceChart"></canvas>
                    </div>

                    <div class="text-center">
                        <a id="detailLink" href="#" target="_blank" class="text-xs text-brand-400 hover:text-brand-300 flex items-center justify-center gap-1">
                            View on CoinGecko <i class="ph ph-arrow-square-out"></i>
                        </a>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <!-- Settings Modal -->
    <div id="settingsModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] flex items-center justify-center">
        <div class="glass-panel p-6 rounded-xl w-full max-w-md mx-4">
            <h3 class="text-xl font-bold mb-4">Settings</h3>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-400 mb-2">CoinGecko Demo API Key (Optional)</label>
                <input type="text" id="apiKeyInput" placeholder="CG-xxxxxxxx" class="w-full bg-gray-900 border border-gray-700 rounded p-2 text-white focus:border-brand-500 outline-none">
                <p class="text-xs text-gray-500 mt-2">Leave empty to use the free public tier (limited rate).</p>
            </div>
            <div class="flex justify-end gap-3">
                <button onclick="app.toggleSettings()" class="px-4 py-2 rounded text-gray-300 hover:bg-gray-800">Cancel</button>
                <button onclick="app.saveSettings()" class="px-4 py-2 rounded bg-brand-600 text-white hover:bg-brand-700">Save</button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="border-t border-gray-800 bg-gray-900 py-6 mt-8">
        <div class="max-w-7xl mx-auto px-4 text-center text-gray-500 text-sm">
            <p>Powered by <a href="https://www.coingecko.com/en/api" class="text-brand-500 hover:underline">CoinGecko API</a>. Data provided for analysis only.</p>
        </div>
    </footer>

    <!-- Application Logic -->
    <script>
        const app = {
            state: {
                coins: [],
                global: null,
                trending: [],
                currency: 'usd',
                apiKey: localStorage.getItem('cg_api_key') || '',
                currentPage: 1,
                chartInstance: null,
                selectedCoinId: null
            },

            // --- API Helpers ---
            
            getHeaders() {
                const headers = { 'accept': 'application/json' };
                if (this.state.apiKey) {
                    headers['x-cg-demo-api-key'] = this.state.apiKey;
                }
                return headers;
            },

            async fetchAPI(endpoint, params = '') {
                const baseUrl = 'https://api.coingecko.com/api/v3';
                const url = `${baseUrl}${endpoint}${params ? '?' + params : ''}`;
                
                try {
                    const response = await fetch(url, { headers: this.getHeaders() });
                    
                    if (response.status === 429) {
                        this.showError('Rate limit exceeded. Waiting 60s before retrying...');
                        return null;
                    }
                    
                    if (!response.ok) throw new Error(`API Error: ${response.status}`);
                    return await response.json();
                } catch (error) {
                    console.error('Fetch error:', error);
                    this.showError('Failed to fetch data. check your connection or rate limits.');
                    return null;
                }
            },

            formatCurrency(num) {
                return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(num);
            },
            
            formatCompact(num) {
                return new Intl.NumberFormat('en-US', { notation: "compact", compactDisplay: "short" }).format(num);
            },

            // --- Core Functions ---

            async init() {
                // Load saved key if exists
                if(this.state.apiKey) document.getElementById('apiKeyInput').value = this.state.apiKey;

                // Initial Data Load
                this.updateStatus('Initializing dashboard...');
                
                await Promise.all([
                    this.loadGlobalStats(),
                    this.loadTrending(),
                    this.loadMarketData(1)
                ]);

                // Setup Search Listener
                this.setupSearch();
                
                // Refresh Button
                document.getElementById('refreshBtn').addEventListener('click', () => {
                    this.loadMarketData(this.state.currentPage);
                    this.loadGlobalStats();
                });
            },

            async loadGlobalStats() {
                const data = await this.fetchAPI('/global');
                if (!data || !data.data) return;
                
                const g = data.data;
                document.getElementById('globalCoins').textContent = g.active_cryptocurrencies;
                document.getElementById('globalExchanges').textContent = g.markets;
                document.getElementById('globalMcap').textContent = this.formatCompact(g.total_market_cap.usd);
                document.getElementById('globalVol').textContent = this.formatCompact(g.total_volume.usd);
                document.getElementById('globalBtcDom').textContent = `${g.market_cap_percentage.btc.toFixed(1)}%`;
            },

            async loadTrending() {
                const data = await this.fetchAPI('/search/trending');
                if (!data || !data.coins) return;

                const container = document.getElementById('trendingList');
                container.innerHTML = ''; // Clear skeleton

                data.coins.slice(0, 5).forEach(coin => {
                    const item = coin.item;
                    const el = document.createElement('div');
                    el.className = 'flex items-center justify-between p-3 rounded-lg bg-gray-800/40 hover:bg-gray-700/50 cursor-pointer transition-colors';
                    el.onclick = () => this.selectCoin(item.id);
                    
                    // Note: Trending API price_btc is often scientific notation, handled loosely here
                    const priceBTC = item.price_btc.toFixed(8); 

                    el.innerHTML = `
                        <div class="flex items-center gap-3">
                            <img src="${item.small}" alt="${item.name}" class="w-8 h-8 rounded-full">
                            <div>
                                <div class="font-bold text-sm text-gray-200">${item.symbol}</div>
                                <div class="text-xs text-gray-500">${item.name}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-brand-400">#${item.market_cap_rank || '?'}</div>
                        </div>
                    `;
                    container.appendChild(el);
                });
            },

            async loadMarketData(page = 1) {
                this.state.currentPage = page;
                this.updateStatus('Updating market prices...');
                
                const data = await this.fetchAPI('/coins/markets', `vs_currency=usd&order=market_cap_desc&per_page=20&page=${page}&sparkline=false&price_change_percentage=24h`);
                
                if (!data) return;

                this.state.coins = data;
                this.renderTable(data);
                
                // Auto-select first coin if none selected
                if (!this.state.selectedCoinId && data.length > 0) {
                    this.selectCoin(data[0].id);
                }
                
                this.hideStatus();
            },

            renderTable(coins) {
                const tbody = document.getElementById('cryptoTableBody');
                tbody.innerHTML = '';

                coins.forEach(coin => {
                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-gray-700/30 transition-colors cursor-pointer border-b border-gray-800 last:border-0';
                    tr.onclick = () => this.selectCoin(coin.id);
                    
                    const isPositive = coin.price_change_percentage_24h >= 0;
                    const changeClass = isPositive ? 'text-green-400' : 'text-red-400';
                    const changeIcon = isPositive ? 'ph-caret-up' : 'ph-caret-down';

                    tr.innerHTML = `
                        <td class="p-4">
                            <div class="flex items-center gap-3">
                                <span class="text-gray-500 w-4 text-xs">${coin.market_cap_rank}</span>
                                <img src="${coin.image}" alt="${coin.name}" class="w-6 h-6 rounded-full">
                                <div>
                                    <span class="font-bold text-gray-200">${coin.symbol.toUpperCase()}</span>
                                    <span class="hidden sm:inline text-xs text-gray-500 ml-1">${coin.name}</span>
                                </div>
                            </div>
                        </td>
                        <td class="p-4 text-right font-medium text-gray-200">${this.formatCurrency(coin.current_price)}</td>
                        <td class="p-4 text-right ${changeClass}">
                            <div class="flex items-center justify-end gap-1">
                                <i class="ph-fill ${changeIcon}"></i>
                                ${Math.abs(coin.price_change_percentage_24h).toFixed(2)}%
                            </div>
                        </td>
                        <td class="p-4 text-right text-gray-400 hidden sm:table-cell">${this.formatCompact(coin.market_cap)}</td>
                        <td class="p-4 text-right text-gray-400 hidden md:table-cell">${this.formatCompact(coin.total_volume)}</td>
                    `;
                    tbody.appendChild(tr);
                });
            },

            async selectCoin(coinId) {
                this.state.selectedCoinId = coinId;
                
                // 1. Get Details
                // We check if it's in our current table list first to save an API call
                let coin = this.state.coins.find(c => c.id === coinId);
                
                // If not in table (e.g. from search/trending), fetch specific data
                if (!coin) {
                    this.updateStatus('Fetching coin details...');
                    const data = await this.fetchAPI(`/coins/${coinId}`, 'localization=false&tickers=false&market_data=true&community_data=false&developer_data=false&sparkline=false');
                    if (data) {
                        // Map complex detail object to flat structure used in render
                        coin = {
                            id: data.id,
                            name: data.name,
                            symbol: data.symbol,
                            image: data.image.large,
                            current_price: data.market_data.current_price.usd,
                            price_change_percentage_24h: data.market_data.price_change_percentage_24h,
                            market_cap: data.market_data.market_cap.usd,
                            high_24h: data.market_data.high_24h.usd,
                            low_24h: data.market_data.low_24h.usd,
                            total_volume: data.market_data.total_volume.usd
                        };
                    } else {
                        return; // Failed to load
                    }
                }

                // 2. Render Details
                this.renderDetailPanel(coin);
                this.hideStatus();

                // 3. Fetch and Render Chart
                this.loadChart(coinId);

                // Scroll to top on mobile to see details
                if (window.innerWidth < 1024) {
                    document.getElementById('coinDetailPanel').scrollIntoView({ behavior: 'smooth' });
                }
            },

            renderDetailPanel(coin) {
                const panel = document.getElementById('coinDetailPanel');
                panel.classList.remove('hidden');

                document.getElementById('detailIcon').src = typeof coin.image === 'string' ? coin.image : coin.image.large || coin.image;
                document.getElementById('detailName').textContent = coin.name;
                document.getElementById('detailSymbol').textContent = coin.symbol.toUpperCase();
                document.getElementById('detailPrice').textContent = this.formatCurrency(coin.current_price);
                
                const changeEl = document.getElementById('detailChange');
                const isPos = coin.price_change_percentage_24h >= 0;
                changeEl.textContent = `${isPos ? '+' : ''}${coin.price_change_percentage_24h.toFixed(2)}% (24h)`;
                changeEl.className = isPos ? 'text-sm font-medium text-green-400' : 'text-sm font-medium text-red-400';

                document.getElementById('detailMcap').textContent = this.formatCompact(coin.market_cap);
                document.getElementById('detailHigh').textContent = this.formatCurrency(coin.high_24h || 0);
                document.getElementById('detailLow').textContent = this.formatCurrency(coin.low_24h || 0);
                document.getElementById('detailVol').textContent = this.formatCompact(coin.total_volume);
                document.getElementById('detailLink').href = `https://www.coingecko.com/en/coins/${coin.id}`;
            },

            async loadChart(coinId) {
                // Destroy old chart
                if (this.state.chartInstance) {
                    this.state.chartInstance.destroy();
                }

                // Show loading state in chart area? No, just keep old one until new one loads or clear.
                const ctx = document.getElementById('priceChart').getContext('2d');
                
                // Fetch OHLC or simple history. Using market_chart for simplicity (free tier friendly)
                // 'days=7' gets hourly data which is good for a simple chart
                const data = await this.fetchAPI(`/coins/${coinId}/market_chart`, 'vs_currency=usd&days=7');
                
                if (!data || !data.prices) return;

                const prices = data.prices; // Array of [timestamp, price]

                // Create Gradient
                const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                gradient.addColorStop(0, 'rgba(59, 130, 246, 0.5)'); // Brand color with opacity
                gradient.addColorStop(1, 'rgba(59, 130, 246, 0.0)');

                this.state.chartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: prices.map(p => new Date(p[0]).toLocaleDateString()),
                        datasets: [{
                            label: 'Price (USD)',
                            data: prices.map(p => p[1]),
                            borderColor: '#3b82f6',
                            backgroundColor: gradient,
                            borderWidth: 2,
                            pointRadius: 0,
                            pointHoverRadius: 4,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                backgroundColor: '#1e293b',
                                titleColor: '#f1f5f9',
                                bodyColor: '#cbd5e1',
                                borderColor: '#334155',
                                borderWidth: 1,
                                callbacks: {
                                    label: (context) => ' ' + this.formatCurrency(context.raw)
                                }
                            }
                        },
                        scales: {
                            x: {
                                display: false, // Clean look
                                grid: { display: false }
                            },
                            y: {
                                display: true,
                                position: 'right',
                                grid: { color: '#334155', drawBorder: false },
                                ticks: { 
                                    color: '#94a3b8',
                                    callback: (val) => '$' + val.toLocaleString()
                                }
                            }
                        },
                        interaction: {
                            mode: 'nearest',
                            axis: 'x',
                            intersect: false
                        }
                    }
                });
            },

            setupSearch() {
                const input = document.getElementById('searchInput');
                const results = document.getElementById('searchResults');
                let timeout = null;

                input.addEventListener('input', (e) => {
                    const query = e.target.value.trim();
                    if (query.length < 2) {
                        results.classList.add('hidden');
                        return;
                    }

                    clearTimeout(timeout);
                    timeout = setTimeout(async () => {
                        const data = await this.fetchAPI('/search', `query=${query}`);
                        if (!data || !data.coins) return;

                        results.innerHTML = '';
                        results.classList.remove('hidden');

                        data.coins.slice(0, 8).forEach(coin => {
                            const div = document.createElement('div');
                            div.className = 'flex items-center gap-3 p-3 hover:bg-gray-700 cursor-pointer transition-colors';
                            div.innerHTML = `
                                <img src="${coin.thumb}" class="w-6 h-6 rounded-full">
                                <div>
                                    <div class="text-sm font-bold text-gray-200">${coin.name}</div>
                                    <div class="text-xs text-gray-500">${coin.symbol}</div>
                                </div>
                                <span class="ml-auto text-xs bg-gray-600 text-gray-300 px-2 py-1 rounded">Rank #${coin.market_cap_rank || '?'}</span>
                            `;
                            div.onclick = () => {
                                this.selectCoin(coin.id);
                                results.classList.add('hidden');
                                input.value = '';
                            };
                            results.appendChild(div);
                        });
                    }, 500); // Debounce
                });

                // Close search when clicking outside
                document.addEventListener('click', (e) => {
                    if (!input.contains(e.target) && !results.contains(e.target)) {
                        results.classList.add('hidden');
                    }
                });
            },

            // --- UI Utilities ---

            showError(msg) {
                const el = document.getElementById('statusMessage');
                const text = document.getElementById('statusText');
                el.className = 'mb-6 p-4 rounded-lg bg-red-900/30 border border-red-700/50 text-red-200 text-sm flex items-center gap-3 fade-in';
                text.textContent = msg;
                el.classList.remove('hidden');
                setTimeout(() => el.classList.add('hidden'), 5000);
            },

            updateStatus(msg) {
                const el = document.getElementById('statusMessage');
                const text = document.getElementById('statusText');
                el.className = 'mb-6 p-4 rounded-lg bg-blue-900/30 border border-blue-700/50 text-blue-200 text-sm flex items-center gap-3 fade-in';
                text.textContent = msg;
                el.classList.remove('hidden');
            },

            hideStatus() {
                document.getElementById('statusMessage').classList.add('hidden');
            },

            toggleSettings() {
                const modal = document.getElementById('settingsModal');
                modal.classList.toggle('hidden');
            },

            saveSettings() {
                const key = document.getElementById('apiKeyInput').value.trim();
                this.state.apiKey = key;
                localStorage.setItem('cg_api_key', key);
                this.toggleSettings();
                this.init(); // Reload with new key
            },

            resetView() {
                window.scrollTo({ top: 0, behavior: 'smooth' });
                this.loadMarketData(1);
            }
        };

        // Initialize App
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });

    </script>
</body>
</html>
